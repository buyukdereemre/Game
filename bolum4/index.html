<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>CILGIN BABAANNE KOSUDA</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Segoe UI', sans-serif; touch-action: none; /* Mobilde sayfa kaymasƒ±nƒ± engeller */ }
        
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;
            display: flex; flex-direction: column; justify-content: space-between; padding: 20px; box-sizing: border-box;
        }
        #score-board {
            color: #ffeb3b; font-size: 28px; font-weight: bold; text-shadow: 2px 2px 4px #000;
            background: rgba(0,0,0,0.5); padding: 10px 20px; border-radius: 20px;
            align-self: flex-start; display: flex; align-items: center; gap: 10px;
        }
        #loading {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: white; font-size: 20px; font-weight: bold; background: rgba(0,0,0,0.8); padding: 20px; border-radius: 10px;
            text-align: center;
        }
        #game-over {
            display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            text-align: center; color: white; z-index: 20; background: rgba(22, 33, 62, 0.95);
            padding: 50px; border-radius: 20px; border: 4px solid #ff0055; min-width: 320px; pointer-events: auto;
        }
        button.restart-btn {
            background: #ff0055; color: white; border: none; padding: 15px 40px; font-size: 22px; 
            font-weight: bold; cursor: pointer; border-radius: 50px; margin-top: 20px;
        }
        
        /* Butonlarƒ± Gizledik */
        .controls { display: none; }
        
        /* Kaydƒ±rma ƒ∞pucu */
        #tutorial {
            position: absolute; bottom: 50px; width: 100%; text-align: center; color: rgba(255,255,255,0.5);
            font-size: 14px; pointer-events: none; animation: blink 2s infinite;
        }
        @keyframes blink { 0% {opacity:0.3;} 50% {opacity:1;} 100% {opacity:0.3;} }
    </style>
</head>
<body>
    <div id="ui-layer">
        <div id="score-board"><span>ü™ô</span> <span id="score-text">0</span></div>
        <a href="../index.html" style="pointer-events:auto; text-decoration:none; color:white; background:rgba(255,255,255,0.2); padding:8px 15px; border-radius:15px; font-size:14px; position: absolute; top: 20px; right: 20px;">Men√º üè†</a>
    </div>
    
    <div id="loading">
        √áILGIN BABAANNE KO≈ûUYA HAZIRLANIYOR<br>
        <span style="font-size:14px; font-weight:normal;">(Biraz s√ºrebilir)</span>
    </div>

    <div id="game-over">
        <h1>Hayƒ±rrrrrr üí•</h1>
        <p>Puan: <span id="final-score" style="color:#ffeb3b;">0</span></p>
        <button class="restart-btn" onclick="location.reload()">Tekrar Oyna ‚Ü∫</button>
    </div>

    <script type="module">
        import * as THREE from 'https://cdn.skypack.dev/three@0.128.0/build/three.module.js';
        import { FBXLoader } from 'https://cdn.skypack.dev/three@0.128.0/examples/jsm/loaders/FBXLoader.js';

        let scene, camera, renderer, clock, mixer;
        let playerContainer, playerModel;
        let obstacles = [], coins = [];
        let score = 0, gameActive = false, speed = 0.4, lane = 0; const laneWidth = 3;
        
        // Fizik Ayarlarƒ±
        let isJumping = false, jumpVelocity = 0, gravity = -0.09, jumpForce = 0.8;
        let playerY = 0;
        let idleAction, jumpAction; 

        // Touch / Kaydƒ±rma Deƒüi≈ükenleri
        let touchStartX = 0;
        let touchStartY = 0;

        init(); animate();

        function init() {
            clock = new THREE.Clock();
            scene = new THREE.Scene(); scene.background = new THREE.Color(0x2d1b4e); scene.fog = new THREE.Fog(0x2d1b4e, 10, 60);
            
            camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 1000);
            // Kamera ba≈ülangƒ±√ß pozisyonu
            camera.position.set(0, 4, 7); 
            camera.lookAt(0, 1.5, -5);

            const hemiLight = new THREE.HemisphereLight(0xffffff, 0x444444, 1); scene.add(hemiLight);
            const dirLight = new THREE.DirectionalLight(0xffffff, 1.5); dirLight.position.set(5, 10, 10); dirLight.castShadow = true; scene.add(dirLight);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight); renderer.shadowMap.enabled = true;
            document.body.appendChild(renderer.domElement);

            const floor = new THREE.Mesh(new THREE.PlaneGeometry(100, 1000), new THREE.MeshPhongMaterial({ color: 0x111111 }));
            floor.rotation.x = -Math.PI / 2; floor.position.z = -200; floor.receiveShadow = true; scene.add(floor);
            const grid = new THREE.GridHelper(100, 40, 0xff0055, 0x333333); grid.position.z = -200; scene.add(grid);

            // --- FBX LOADER ---
            const loader = new FBXLoader();
            
            loader.load('./model.fbx', function (object) {
                playerModel = object;
                playerModel.scale.set(0.01, 0.01, 0.01); 
                playerModel.rotation.set(0, Math.PI, 0);
                
                playerModel.traverse(function (child) {
                    if (child.isMesh) {
                        child.castShadow = true;
                        child.receiveShadow = true;
                    }
                });

                mixer = new THREE.AnimationMixer(playerModel);
                if(playerModel.animations.length > 0) {
                    idleAction = mixer.clipAction(playerModel.animations[0]);
                    idleAction.play();
                }

                playerContainer = new THREE.Group(); 
                playerContainer.add(playerModel); 
                playerContainer.position.z = 0;
                scene.add(playerContainer);

                // Zƒ±plama Animasyonu
                loader.load('./jump.fbx', function (jumpObject) {
                    if (jumpObject.animations.length > 0) {
                        const jumpClip = jumpObject.animations[0];
                        jumpAction = mixer.clipAction(jumpClip);
                        jumpAction.setLoop(THREE.LoopOnce);
                        jumpAction.clampWhenFinished = true;
                    }
                    document.getElementById('loading').style.display = 'none'; 
                    gameActive = true;
                }, undefined, function(e) { console.error("Jump hatasƒ±", e); });

            }, undefined, function (error) {
                console.error("Model hatasƒ±:", error);
                document.getElementById('loading').innerHTML = "MODEL HATASI!";
            });

            // --- KLAVYE KONTROLLERƒ∞ (PC ƒ∞√áƒ∞N) ---
            window.addEventListener('keydown', (e) => {
                if (e.key === 'ArrowLeft' || e.key === 'a') movePlayer(-1); 
                if (e.key === 'ArrowRight' || e.key === 'd') movePlayer(1);
                if (e.key === ' ' || e.key === 'ArrowUp' || e.key === 'w') handleJump();
            });

            // --- DOKUNMATƒ∞K / KAYDIRMA KONTROLLERƒ∞ (MOBƒ∞L ƒ∞√áƒ∞N) ---
            document.addEventListener('touchstart', (e) => {
                touchStartX = e.changedTouches[0].screenX;
                touchStartY = e.changedTouches[0].screenY;
            }, {passive: false});

            document.addEventListener('touchend', (e) => {
                if (!gameActive) return;
                
                const touchEndX = e.changedTouches[0].screenX;
                const touchEndY = e.changedTouches[0].screenY;
                
                handleSwipe(touchStartX, touchStartY, touchEndX, touchEndY);
            }, {passive: false});
        }

        function handleSwipe(startX, startY, endX, endY) {
            const diffX = endX - startX;
            const diffY = endY - startY;
            const threshold = 30; // En az bu kadar kaydƒ±rƒ±lmalƒ±

            // Yatay mƒ± Dikey mi daha √ßok kaydƒ±rƒ±ldƒ±?
            if (Math.abs(diffX) > Math.abs(diffY)) {
                // Yatay Hareket (Saƒü/Sol)
                if (Math.abs(diffX) > threshold) {
                    if (diffX > 0) movePlayer(1); // Saƒüa
                    else movePlayer(-1); // Sola
                }
            } else {
                // Dikey Hareket (Sadece Yukarƒ± - Zƒ±plama)
                if (diffY < -threshold) { // Yukarƒ± kaydƒ±rma (Negatif Y)
                    handleJump();
                }
            }
        }

        function handleJump() {
            if (isJumping || !gameActive) return;
            isJumping = true;
            jumpVelocity = jumpForce;
            
            if (jumpAction) {
                if (idleAction) idleAction.fadeOut(0.2); 
                jumpAction.reset();
                jumpAction.fadeIn(0.2);
                jumpAction.play();
            }
        }

        function movePlayer(dir) {
            lane += dir;
            if (lane < -1) lane = -1;
            if (lane > 1) lane = 1;
        }

        function animate() {
            requestAnimationFrame(animate);
            const delta = clock.getDelta(); 
            if (mixer) mixer.update(delta);
            
            if (!gameActive) return;

            // Fƒ∞Zƒ∞K
            if (isJumping) {
                jumpVelocity += gravity;
                playerY += jumpVelocity;
                
                if (playerY <= 0) {
                    playerY = 0;
                    isJumping = false;
                    jumpVelocity = 0;
                    
                    if (jumpAction) jumpAction.fadeOut(0.2);
                    if (idleAction) {
                        idleAction.reset();
                        idleAction.fadeIn(0.2);
                        idleAction.play();
                    }
                }
            }

            if (playerContainer) {
                // 1. Oyuncuyu Hareket Ettir
                playerContainer.position.x += (lane * laneWidth - playerContainer.position.x) * 0.15;
                playerContainer.position.y = playerY;

                camera.position.x += (playerContainer.position.x - camera.position.x) * 0.1;
                // Kamera her zaman hafif √∂n√ºne baksƒ±n
                camera.lookAt(playerContainer.position.x * 0.5, 1.5, -5);
            }

            if (Math.random() < 0.03) Math.random() < 0.6 ? createCoin() : createObstacle();

            obstacles.forEach((ob, i) => {
                ob.position.z += speed;
                if (ob.position.z > -1 && ob.position.z < 1) {
                    if (playerContainer && playerY < 0.5 && Math.abs(ob.position.x - playerContainer.position.x) < 0.8) {
                        gameActive = false; 
                        document.getElementById('final-score').innerText = score;
                        document.getElementById('game-over').style.display = 'block';
                    }
                }
                if (ob.position.z > 10) { scene.remove(ob); obstacles.splice(i, 1); }
            });

            coins.forEach((c, i) => {
                c.position.z += speed; c.rotation.y += 0.1;
                if (c.position.z > -1 && c.position.z < 1) {
                    if (playerContainer && Math.abs(c.position.x - playerContainer.position.x) < 0.8) {
                        score += 10; document.getElementById('score-text').innerText = score;
                        scene.remove(c); coins.splice(i, 1);
                    }
                }
                if (c.position.z > 10) { scene.remove(c); coins.splice(i, 1); }
            });

            speed += 0.0001; 
            renderer.render(scene, camera);
        }

        function createObstacle() {
            const obs = new THREE.Mesh(new THREE.BoxGeometry(2, 2, 1), new THREE.MeshPhongMaterial({ color: 0xff0055 }));
            obs.position.set((Math.floor(Math.random()*3)-1)*laneWidth, 1, -60); obs.castShadow = true; scene.add(obs); obstacles.push(obs);
        }
        function createCoin() {
            const coin = new THREE.Mesh(new THREE.CylinderGeometry(0.5, 0.5, 0.1, 10), new THREE.MeshPhongMaterial({ color: 0xffeb3b }));
            coin.position.set((Math.floor(Math.random()*3)-1)*laneWidth, 1.5, -60); coin.rotation.x = Math.PI/2; coin.castShadow = true; scene.add(coin); coins.push(coin);
        }
        window.addEventListener('resize', () => { camera.aspect = window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); });
    </script>
</body>
</html>