<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Sonsuz A≈ük Ko≈üusu</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Segoe UI', sans-serif; }
        
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;
            display: flex; flex-direction: column; justify-content: space-between; padding: 20px; box-sizing: border-box;
        }
        #score-board {
            color: #ffeb3b; font-size: 28px; font-weight: bold; text-shadow: 2px 2px 4px #000;
            background: rgba(0,0,0,0.5); padding: 10px 20px; border-radius: 20px;
            align-self: flex-start; display: flex; align-items: center; gap: 10px;
        }
        #loading {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: white; font-size: 20px; font-weight: bold; background: rgba(0,0,0,0.8); padding: 20px; border-radius: 10px;
            text-align: center;
        }
        #game-over {
            display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            text-align: center; color: white; z-index: 20; background: rgba(22, 33, 62, 0.95);
            padding: 50px; border-radius: 20px; border: 4px solid #ff0055; min-width: 320px; pointer-events: auto;
        }
        button.restart-btn {
            background: #ff0055; color: white; border: none; padding: 15px 40px; font-size: 22px; 
            font-weight: bold; cursor: pointer; border-radius: 50px; margin-top: 20px;
        }
        .controls {
            position: absolute; bottom: 20px; width: 100%; display: flex;
            justify-content: space-between; padding: 0 50px; pointer-events: none;
        }
        .btn-mobile {
            width: 80px; height: 80px; background: rgba(255, 255, 255, 0.2); border-radius: 50%; border: 2px solid white; 
            pointer-events: auto; display: flex; align-items: center; justify-content: center; font-size: 30px; color: white; display: none; cursor: pointer;
        }
        #jumpBtn { 
            position: fixed !important; bottom: 120px !important; right: 30px !important;
            width: 70px !important; height: 70px !important; background: rgba(255, 200, 0, 0.3) !important; border: 2px solid #ffeb3b !important;
        }
        @media (max-width: 768px) { .btn-mobile { display: flex; } }
    </style>
</head>
<body>
    <div id="ui-layer">
        <div id="score-board"><span>ü™ô</span> <span id="score-text">0</span></div>
        <a href="../index.html" style="pointer-events:auto; text-decoration:none; color:white; background:rgba(255,255,255,0.2); padding:8px 15px; border-radius:15px; font-size:14px; position: absolute; top: 20px; right: 20px;">Men√º üè†</a>
    </div>
    
    <div id="loading">
        FBX DOSYASI Y√úKLENƒ∞YOR...<br>
        <span style="font-size:14px; font-weight:normal;">(Biraz s√ºrebilir)</span>
    </div>

    <div id="game-over">
        <h1>√áARPTIN! üí•</h1>
        <p>Puan: <span id="final-score" style="color:#ffeb3b;">0</span></p>
        <button class="restart-btn" onclick="location.reload()">TEKRAR OYNA ‚Ü∫</button>
    </div>
    <div class="controls"><div class="btn-mobile" id="leftBtn">‚¨ÖÔ∏è</div><div class="btn-mobile" id="rightBtn">‚û°Ô∏è</div><div class="btn-mobile" id="jumpBtn">‚¨ÜÔ∏è</div></div>

    <script type="module">
        import * as THREE from 'https://cdn.skypack.dev/three@0.128.0/build/three.module.js';
        import { FBXLoader } from 'https://cdn.skypack.dev/three@0.128.0/examples/jsm/loaders/FBXLoader.js';

        let scene, camera, renderer, clock, mixer;
        let playerContainer, playerModel;
        let obstacles = [], coins = [];
        let score = 0, gameActive = false, speed = 0.4, lane = 0; const laneWidth = 3;
        
        // Zƒ±plama Fizik Deƒüi≈ükenleri
        let isJumping = false, jumpVelocity = 0, gravity = -0.09, jumpForce = 1;
        let playerY = 0;
        
        // Animasyon Deƒüi≈ükenleri
        let idleAction, jumpAction; 

        init(); animate();

        function init() {
            clock = new THREE.Clock();
            scene = new THREE.Scene(); scene.background = new THREE.Color(0x2d1b4e); scene.fog = new THREE.Fog(0x2d1b4e, 10, 60);
            camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 1000);
            camera.position.set(0, 4, 7); camera.lookAt(0, 1.5, -5);

            const hemiLight = new THREE.HemisphereLight(0xffffff, 0x444444, 1); scene.add(hemiLight);
            const dirLight = new THREE.DirectionalLight(0xffffff, 1.5); dirLight.position.set(5, 10, 10); dirLight.castShadow = true; scene.add(dirLight);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight); renderer.shadowMap.enabled = true;
            document.body.appendChild(renderer.domElement);

            const floor = new THREE.Mesh(new THREE.PlaneGeometry(100, 1000), new THREE.MeshPhongMaterial({ color: 0x111111 }));
            floor.rotation.x = -Math.PI / 2; floor.position.z = -200; floor.receiveShadow = true; scene.add(floor);
            const grid = new THREE.GridHelper(100, 40, 0xff0055, 0x333333); grid.position.z = -200; scene.add(grid);

            // --- FBX LOADER ---
            const loader = new FBXLoader();
            
            // 1. √ñnce Karakter Modelini Y√ºkle
            loader.load('./model.fbx', function (object) {
                playerModel = object;
                playerModel.scale.set(0.01, 0.01, 0.01); 
                playerModel.rotation.set(0, Math.PI, 0);
                
                playerModel.traverse(function (child) {
                    if (child.isMesh) {
                        child.castShadow = true;
                        child.receiveShadow = true;
                    }
                });

                // Mixer'ƒ± ana model √ºzerinde olu≈üturuyoruz
                mixer = new THREE.AnimationMixer(playerModel);
                
                // Eƒüer modelin i√ßinde (idle/ko≈üma) animasyonu varsa ba≈ülat
                if(playerModel.animations.length > 0) {
                    idleAction = mixer.clipAction(playerModel.animations[0]);
                    idleAction.play();
                }

                playerContainer = new THREE.Group(); 
                playerContainer.add(playerModel); 
                playerContainer.position.z = 0;
                scene.add(playerContainer);

                console.log("Model y√ºklendi. ≈ûimdi zƒ±plama y√ºkleniyor...");

                // 2. ≈ûimdi Zƒ±plama Animasyonunu Y√ºkle (ƒ∞√ß i√ße y√ºkleme daha g√ºvenlidir)
                loader.load('./jump.fbx', function (jumpObject) {
                    console.log("Jump dosyasƒ± okundu.");
                    
                    if (jumpObject.animations.length > 0) {
                        // Jump dosyasƒ±ndaki ilk animasyonu al
                        const jumpClip = jumpObject.animations[0];
                        
                        // Bu animasyonu mevcut karakterin mixer'ine baƒüla
                        jumpAction = mixer.clipAction(jumpClip);
                        
                        // Zƒ±plama ayarlarƒ±: Sadece 1 kere oyna, bitince son karede kalmasƒ±n (biz y√∂neteceƒüiz)
                        jumpAction.setLoop(THREE.LoopOnce);
                        jumpAction.clampWhenFinished = true;
                        
                        console.log("Zƒ±plama animasyonu ba≈üarƒ±yla baƒülandƒ±!");
                    } else {
                        console.error("Jump.fbx i√ßinde animasyon bulunamadƒ±!");
                    }

                    // Her ≈üey hazƒ±r
                    document.getElementById('loading').style.display = 'none'; 
                    gameActive = true;
                    
                }, undefined, function(e) { console.error("Jump y√ºklenemedi", e); });

            }, undefined, function (error) {
                console.error("Model y√ºklenemedi:", error);
                document.getElementById('loading').innerHTML = "MODEL HATASI!";
            });

            // Kontroller
            window.addEventListener('keydown', (e) => {
                if (e.key === 'ArrowLeft' || e.key === 'a') movePlayer(-1); 
                if (e.key === 'ArrowRight' || e.key === 'd') movePlayer(1);
                // Bo≈üluk tu≈üu veya Yukarƒ± ok ile zƒ±plama
                if (e.key === ' ' || e.key === 'ArrowUp' || e.key === 'w') handleJump();
            });
            
            document.getElementById('leftBtn').addEventListener('touchstart', (e) => { e.preventDefault(); movePlayer(-1); });
            document.getElementById('rightBtn').addEventListener('touchstart', (e) => { e.preventDefault(); movePlayer(1); });
            document.getElementById('jumpBtn').addEventListener('touchstart', (e) => { e.preventDefault(); handleJump(); });
            
            if (!/Android|webOS|iPhone|iPad|iPod|BlackBerry/i.test(navigator.userAgent)) {
                window.addEventListener('mousedown', (e) => { 
                    // Ekrana tƒ±klayƒ±nca zƒ±plamasƒ±n, sadece saƒü sol yapsƒ±n (zƒ±plama space ile)
                    if(e.clientX < window.innerWidth / 2) movePlayer(-1); else movePlayer(1); 
                });
            }
        }

        function handleJump() {
            if (isJumping || !gameActive) return; // Zaten havadaysa tekrar zƒ±plamasƒ±n
            
            isJumping = true;
            jumpVelocity = jumpForce;
            
            // Animasyon Ge√ßi≈üi
            if (jumpAction) {
                if (idleAction) idleAction.fadeOut(0.2); // Ko≈ümayƒ± yava≈ü√ßa durdur
                jumpAction.reset(); // Zƒ±plamayƒ± ba≈üa sar
                jumpAction.fadeIn(0.2); // Zƒ±plamayƒ± yava≈ü√ßa ba≈ülat
                jumpAction.play();
            }
        }

        function movePlayer(dir) {
            lane += dir;
            if (lane < -1) lane = -1;
            if (lane > 1) lane = 1;
        }

        function animate() {
            requestAnimationFrame(animate);
            const delta = clock.getDelta(); 
            if (mixer) mixer.update(delta);
            
            if (!gameActive) return;

            // --- Fƒ∞Zƒ∞K VE ZIPLAMA MANTIƒûI ---
            if (isJumping) {
                jumpVelocity += gravity;
                playerY += jumpVelocity;
                
                // Yere deƒüme kontrol√º
                if (playerY <= 0) {
                    playerY = 0;
                    isJumping = false;
                    jumpVelocity = 0;
                    
                    // Yere inince tekrar ko≈üma animasyonuna ge√ß
                    if (jumpAction) jumpAction.fadeOut(0.2);
                    if (idleAction) {
                        idleAction.reset();
                        idleAction.fadeIn(0.2);
                        idleAction.play();
                    }
                }
            }

            if (playerContainer) {
                playerContainer.position.x += (lane * laneWidth - playerContainer.position.x) * 0.15;
                playerContainer.position.y = playerY; // Zƒ±plama y√ºksekliƒüini uygula
            }

            // Objeleri olu≈ütur
            if (Math.random() < 0.03) Math.random() < 0.6 ? createCoin() : createObstacle();

            // Engelleri y√∂net
            obstacles.forEach((ob, i) => {
                ob.position.z += speed;
                // √áarpƒ±≈üma: Eƒüer havadaysan (playerY > 1.0) engelin √ºst√ºnden ge√ßersin
                if (ob.position.z > -1 && ob.position.z < 1) {
                    if (playerContainer && playerY < 0.5 && Math.abs(ob.position.x - playerContainer.position.x) < 0.8) {
                        gameActive = false; 
                        document.getElementById('final-score').innerText = score;
                        document.getElementById('game-over').style.display = 'block';
                    }
                }
                if (ob.position.z > 10) { scene.remove(ob); obstacles.splice(i, 1); }
            });

            // Coinleri y√∂net
            coins.forEach((c, i) => {
                c.position.z += speed; c.rotation.y += 0.1;
                if (c.position.z > -1 && c.position.z < 1) {
                    // Coin her t√ºrl√º toplanƒ±r (havada veya yerde)
                    if (playerContainer && Math.abs(c.position.x - playerContainer.position.x) < 0.8) {
                        score += 10; document.getElementById('score-text').innerText = score;
                        scene.remove(c); coins.splice(i, 1);
                    }
                }
                if (c.position.z > 10) { scene.remove(c); coins.splice(i, 1); }
            });

            speed += 0.0001; 
            renderer.render(scene, camera);
        }

        function createObstacle() {
            const obs = new THREE.Mesh(new THREE.BoxGeometry(2, 2, 1), new THREE.MeshPhongMaterial({ color: 0xff0055 }));
            obs.position.set((Math.floor(Math.random()*3)-1)*laneWidth, 1, -60); obs.castShadow = true; scene.add(obs); obstacles.push(obs);
        }
        function createCoin() {
            const coin = new THREE.Mesh(new THREE.CylinderGeometry(0.5, 0.5, 0.1, 10), new THREE.MeshPhongMaterial({ color: 0xffeb3b }));
            coin.position.set((Math.floor(Math.random()*3)-1)*laneWidth, 1.5, -60); coin.rotation.x = Math.PI/2; coin.castShadow = true; scene.add(coin); coins.push(coin);
        }
        window.addEventListener('resize', () => { camera.aspect = window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); });
    </script>
</body>
</html>